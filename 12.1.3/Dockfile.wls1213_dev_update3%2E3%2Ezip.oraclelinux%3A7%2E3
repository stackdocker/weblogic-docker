FROM docker.io/oraclelinux:7.3
MAINTAINER tangfeixiong <tangfx128@gmail.com>
# Inspired by: Anastas Dancha <anapsix@random.io>, playniuniu@gmail.com, 
# and [Oracle Github-ed Java, Weblogic guide](https://github.com/oracle/docker-images)

# ARG oracle_java_url="http://download.oracle.com/otn-pub/java/jdk/8u112-b15/server-jre-8u112-linux-x64.tar.gz"
# ARG oracle_java_url="http://download.oracle.com/otn-pub/java/jdk/7u80-b15/server-jre-7u80-linux-x64.tar.gz"
ARG oracle_java_url="http://172.17.4.1:48080/99-mirror/http%3A%2F%2Fdownload.oracle.com/otn-pub%2Fjava%2Fjdk%2F7u80-b15/server-jre-7u80-linux-x64.tar.gz"
# ARG curl_java_opt="--header \"Cookie: oraclelicense=accept-securebackup-cookie; \""
ARG curl_java_opt
ARG oracle_weblogic_url="http://172.17.4.1:48080/99-mirror/http%3A%2F%2Fdownload.oracle.com/otn%2Fnt%2Fmiddleware%2F12c%2Fwls%2F1213/wls1213_dev_update3.zip"
# ARG oraclelinux_rpm_url="http://172.17.4.1:48080/99-mirror/http%3A%2F%2Fpublic-yum.oracle.com/repo%2FOracleLinux%2FOL7%2Flatest%2Fx86_64"
ARG oraclelinux_rpm_url="http://172.17.4.1:48080/99-mirror/%2E%2Eworkspace%2Fsrc%2Fgithub.com%2Fstackdocker%2Fweblogic-docker%2Fdownload%2Foraclelinux7%2Frpm"
ARG wls_domain_name
ARG wls_admin_username
ARG wls_admin_password

COPY /12.1.3/ /tmp/build/

ENV JAVA_HOME="/opt/java" \
    MW_HOME="/opt/fmw" \
    WL_HOME="/opt/fmw/wlserver" \
    DOMAIN_HOME="/opt/fmw/user_projects/domains/${wls_domain_name:-base_domain}" \
    ADMIN_PORT="8001" \
    ADMIN_HOST="wlsadmin" \
    NM_PORT="5556" \
    MS_PORT="7001" \
    CONFIG_JVM_ARGS="-Dweblogic.security.SSL.ignoreHostnameVerification=true" \
    USER_MEM_ARGS="-Djava.security.egd=file:/dev/./urandom" \
    DEBUG_PORT="8453" \
    DEBUG_FLAG="true" \
    PRODUCTION_MODE="dev" \
    PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/java/bin:/opt/fmw/oracle_common/common/bin:/opt/fmw/wlserver/common/bin:/opt/fmw/user_projects/domains/${wls_domain_name:-base_domain}/bin:/opt/fmw"

### WORKDIR /tmp

RUN temp_dir=/tmp/build \
    && mkdir -p $JAVA_HOME \
    && curl -jkSL ${curl_java_opt:-''} \
        ${oracle_java_url//%/%25} \
        | gunzip \
        | tar -x -C $JAVA_HOME --strip-components=1 \
    && export PATH=$PATH:$JAVA_HOME/bin \
    && javaSlim=" \
        README.html \
        release \
        THIRDPARTYLICENSEREADME*.txt \
        *src.zip \
        db \
        jre/README \
        jre/THIRDPARTYLICENSEREADME*.txt \
        jre/Welcome.html \
        jre/plugin \
        jre/bin/javaws \
        jre/bin/jjs \
        jre/bin/keytool \
        jre/bin/orbd \
        jre/bin/pack200 \
        jre/bin/policytool \
        jre/bin/rmid \
        jre/bin/rmiregistry \
        jre/bin/servertool \
        jre/bin/tnameserv \
        jre/bin/unpack200 \
        jre/lib/javaws.jar \
        jre/lib/deploy* \
        jre/lib/desktop \
        jre/lib/*javafx* \
        jre/lib/*jfx* \
        jre/lib/amd64/libdecora_sse.so \
        jre/lib/amd64/libprism_*.so \
        jre/lib/amd64/libfxplugins.so \
        jre/lib/amd64/libglass.so \
        jre/lib/amd64/libgstreamer-lite.so \
        jre/lib/amd64/libjavafx*.so \
        jre/lib/amd64/libjfx*.so \
        jre/lib/ext/jfxrt.jar \
        jre/lib/nashorn.jar \
        jre/lib/oblique-fonts \
        jre/lib/plugin.jar \
        lib/*javafx* \
        lib/missioncontrol \
        lib/visualvm \
        man/ja \
        man/ja_JP.UTF-8 \
    " \
    && for i in $javaSlim; do \
        rm -rf $JAVA_HOME/$i; \
    done \
    && install_RPMs=" \
        unzip-6.0-16.el7.x86_64.rpm \
    " \
    && for i in $install_RPMs; do \
        rpm -Uvh ${oraclelinux_rpm_url//%/%25}/$i; \
    done \
    && install_PKGs="unzip" \
    ### yum install -y $install_PKGs 
    ### rpm -V $install_PKGs 
    ### yum clean all 
    && mkdir -p $temp_dir/download \
    && curl -jkSL ${oracle_weblogic_url//%/%25} -o $temp_dir/download/wls.zip \
    && wls_tmpdir=$(mktemp --dry-run) \
    && unzip -qd $wls_tmpdir $temp_dir/download/wls.zip \
    && rm $temp_dir/download/wls.zip \
    && wls_path=$(basename $(ls -d $wls_tmpdir/wls*)) \
    && mv $wls_tmpdir/$wls_path $MW_HOME \
    && rm -rf $wls_tmpdir \
    && export PATH=$PATH:$MW_HOME/oracle_common/common/bin:$WL_HOME/common/bin \
    && weblogicSlim=" \
        configure.cmd \
        README_WIN \
        coherence/bin/*.cmd \
        coherence/bin/optimize.reg \
        coherence/bin/readme \
        oracle_common/bin/*.bat \
        oracle_common/common/bin/*.cmd \
        oracle_common/common/modules/datadirect/*.dll \
        oracle_common/common/modules/mysql-connector-java-commercial-5.1.22/docs \
        oracle_common/common/modules/mysql-connector-java-commercial-5.1.22/CHANGES \
        oracle_common/common/modules/mysql-connector-java-commercial-5.1.22/*README* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_de.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_es.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_fr.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_it.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_ja.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_ko.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_pt_BR.* \
        oracle_common/common/modules/oracle.fmwconfig.common.wls.help/wl???_zh_TW.* \
        oracle_common/common/modules/org.apache.ant_1.9.2/bin/*.bat \
        oracle_common/common/modules/org.apache.ant_1.9.2/bin/*.cmd \
        oracle_common/common/modules/org.apache.ant_1.9.2/manual \
        oracle_common/common/modules/org.apache.ant_1.9.2/INSTALL \
        oracle_common/common/modules/org.apache.ant_1.9.2/README \
        oracle_common/common/modules/org.apache.ant_1.9.2/WHATSNEW \ 
        oracle_common/common/modules/org.apache.maven_3.0.5/bin/*.bat \
        wlserver/common/bin/*.cmd \
        wlserver/server/bin/international \
        wlserver/server/bin/*.exe \
        wlserver/server/bin/*.dll \
        wlserver/server/bin/*.lib \
        wlserver/server/bin/*.cmd \
        wlserver/server/db2 \
        wlserver/server/informix \
        wlserver/server/sybase \
        wlserver/server/include/aixppc* \
        wlserver/server/include/hp-ux \
        wlserver/server/include/lnx_s* \
        wlserver/server/include/lnxi* \
        wlserver/server/include/win32 \
        wlserver/server/include/platform/aixppc* \
        wlserver/server/include/platform/hp-ux \
        wlserver/server/include/platform/lnx_s* \
        wlserver/server/include/platform/lnxi* \
        wlserver/server/include/platform/win32 \
        wlserver/server/lib/weblogic-de.* \
        wlserver/server/lib/weblogic-es.* \
        wlserver/server/lib/weblogic-fr.* \
        wlserver/server/lib/weblogic-it.* \
        wlserver/server/lib/weblogic-js.* \
        wlserver/server/lib/weblogic-ko.* \
        wlserver/server/lib/weblogic-pt_BR.* \
        wlserver/server/lib/weblogic-zh_TW.* \
        wlserver/server/lib/wlw-langx-jx.* \
        wlserver/server/lib/wlw-langx-ko.* \
        wlserver/server/lib/wlw-langx-zh_TW.* \
        wlserver/server/locale/C/aix-*,hpux-* \
        wlserver/server/locale/C/linux-i* \
        wlserver/server/locale/C/linux-s* \
        wlserver/server/locale/C/solaris-* \
        wlserver/server/locale/C/win* \
        wlserver/server/native/linux/i686 \
        wlserver/server/native/win \
        wlserver/sip/server/native/linux/i686 \
        wlserver/sip/server/native/solaris \
    " \
    && for i in $weblogicSlim; \
        do rm -rf $MW_HOME/$i; \
    done \
    && . $MW_HOME/configure.sh -silent \
    && . $MW_HOME/wlserver/server/bin/setWLSEnv.sh \
    && for i in $(ls $temp_dir/container-scripts/{*.py,*.sh}); do \
        sed -i "s%/u01/oracle/%$MW_HOME/%g" $i; \
    done \ 
    && mv $temp_dir/container-scripts/* $MW_HOME \
    && rm -rf $temp_dir/container-scripts \
    && export PATH=$PATH:$DOMAIN_HOME/bin:$MW_HOME \
    && ADMIN_PASSWORD=${wls_admin_password:-weblogic1234%^&*} $MW_HOME/wlst $MW_HOME/create-wls-domain.py \
    && mkdir -p $DOMAIN_HOME/servers/AdminServer/security \
    && echo -e "username=${wls_admin_username:-weblogic}\npassword=${wls_admin_password:-weblogic1234%^&*}" | tee $DOMAIN_HOME/servers/AdminServer/security/boot.properties \
    && echo -e "\n. $DOMAIN_HOME/bin/setDomainEnv.sh\n\nexport PATH=$PATH" | tee -a $HOME/.bashrc \
    && cp $MW_HOME/commEnv.sh $WL_HOME/common/bin/commEnv.sh \
    && rm $MW_HOME/create-wls-domain.py $MW_HOME/jaxrs2-template.jar \
    && yum remove -y $install_PKGs \
    && ( [ -f $temp_dir/sample.war ] && mv $temp_dir/sample.war $DOMAIN_HOME/autodeploy ) \
    && rm -rf $temp_dir

ENV JAVA_OPTIONS "-Xms512m -Xmx512m -XX:PermSize=64m -XX:MaxPermSize=256m" 
VOLUME ["$DOMAIN_HOME/autodeploy"]
EXPOSE $NM_PORT $ADMIN_PORT $MS_PORT $DEBUG_PORT
CMD ["startWebLogic.sh"]
